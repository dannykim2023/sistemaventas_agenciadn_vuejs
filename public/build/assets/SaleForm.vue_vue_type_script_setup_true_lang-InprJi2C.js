import{d as G,r as N,A as S,k as _,w as $,c as p,f as e,g as c,b as h,t as i,e as R,i as D,u as l,J as A,B as a,C as u,D as y,F as w,G as C,L as B,K as O,a as z,o as m}from"./app-Cu1ZTOfv.js";import{C as H}from"./CustomerModal-CquWBU31.js";const J={class:"flex items-center justify-between mb-4"},K={class:"text-xl font-semibold"},W={class:"flex gap-2"},Y=["disabled"],Z={key:0,class:"mb-3 p-2 rounded bg-red-50 text-[11px] text-red-600"},Q={class:"bg-white rounded-2xl shadow-sm border overflow-hidden"},X={class:"px-8 pt-6 pb-4 flex items-start justify-between gap-6 border-b"},tt={class:"text-right space-y-2"},et={class:"text-2xl font-semibold leading-tight"},st={class:"align-middle text-base text-muted-foreground"},ot={class:"grid grid-cols-2 gap-2 text-xs"},nt={class:"text-left"},lt={key:0,class:"mt-1 text-[10px] text-red-500"},dt={class:"text-left"},rt={key:0,class:"mt-1 text-[10px] text-red-500"},at={class:"px-8 py-4 grid md:grid-cols-2 gap-6 bg-slate-50/60 border-b"},it={class:"space-y-3"},ut={class:"flex items-end gap-2"},pt=["value"],mt={class:"grid sm:grid-cols-2 gap-3"},xt={class:"grid sm:grid-cols-2 gap-3"},ct={class:"px-8 pt-4 pb-2"},bt={class:"overflow-x-auto"},yt={class:"w-full text-xs md:text-sm"},ft={class:"bg-slate-50 border-y"},gt={class:"text-left"},vt={class:"p-2 w-24 text-right"},_t={class:"p-2"},wt=["onUpdate:modelValue","onChange"],kt=["value"],Ut={class:"p-2"},Vt=["onUpdate:modelValue"],Nt={class:"p-2 text-right"},Ct=["onUpdate:modelValue"],qt={class:"p-2 text-right"},St=["onUpdate:modelValue"],ht={class:"p-2 text-right"},Dt=["onUpdate:modelValue"],jt={class:"p-2 text-right"},Tt=["onUpdate:modelValue"],Ft={class:"p-2 text-right font-medium"},Mt={class:"p-2 text-right"},Et=["onClick"],It={class:"px-8 pb-8 pt-4 border-t grid md:grid-cols-3 gap-6"},Lt={class:"md:col-span-2"},Pt={class:"bg-slate-50 rounded-xl border px-4 py-4 flex flex-col gap-2 justify-between"},Gt={class:"space-y-1 text-sm"},$t={class:"flex justify-between"},Rt={class:"flex justify-between"},At={class:"border-t mt-2 pt-2 flex justify-between font-semibold"},Bt={key:1,class:"px-8 pb-8 pt-4 border-t mt-4 bg-slate-50/60 rounded-b-2xl"},Ot={class:"flex items-center justify-between mb-3"},zt={class:"flex items-center gap-2 text-xs"},Ht={key:0,class:"grid md:grid-cols-4 gap-3 items-end"},Jt={key:1,class:"mt-3"},Yt=G({__name:"SaleForm",props:{customers:{},products:{},quotation:{},quotations:{},defaultSeries:{},nextNumber:{},sale:{}},setup(j){const f=N(!1);S({type:"company",document_type:"RUC",document_number:"",name:"",email:"",phone:"",address:"",notes:"",is_active:!0});const d=j;function k(){return new Date().toISOString().substring(0,10)}const g=_(()=>!!d.sale),o=S({customer_id:d.sale?.customer_id??d.quotation?.customer_id??null,quotation_id:d.quotation?.id??null,customer_tax_id:d.sale?.customer?.document_number??d.quotation?.customer?.document_number??"",customer_phone:d.sale?.customer?.phone??d.quotation?.customer?.phone??"",series:d.sale?.series??d.defaultSeries,number:d.sale?.number??d.nextNumber,issue_date:d.sale?.issue_date??k(),due_date:d.sale?.due_date??d.quotation?.valid_until??k(),payment_term:d.sale?.payment_term??"",currency:d.sale?.currency??"PEN",register_payment:!1,payment_date:k(),payment_amount:null,payment_method:"",payment_reference:"",payment_notes:"",items:d.sale?d.sale.items.map(n=>({product_id:n.product_id??null,description:n.description??n.product?.name??"",unit:n.unit??n.product?.unit??"UND",quantity:n.quantity??1,unit_price:n.unit_price??n.product?.price??0,discount:n.discount??0,tax_percent:n.tax_percent??n.product?.tax_pct??18})):d.quotation?.items?.length?d.quotation.items.map(n=>({product_id:n.product_id??null,description:n.description??n.product?.name??"",unit:n.unit??n.product?.unit??"UND",quantity:n.quantity??1,unit_price:n.unit_price??n.product?.price??0,discount:n.discount??0,tax_percent:n.tax_percent??n.product?.tax_pct??18})):[{product_id:null,description:"",unit:"UND",quantity:1,unit_price:0,discount:0,tax_percent:18}],notes:d.sale?.notes??d.quotation?.notes??""}),T=N("");N(!1),_(()=>{const n=d.quotations??[],t=T.value.trim().toLowerCase();return t?n.filter(s=>{const x=String(s.number??`CTZ-${s.id}`).toLowerCase(),r=String(s.customer?.name??"").toLowerCase();return x.includes(t)||r.includes(t)}):n});const b=_(()=>o.currency==="USD"?"$":"S/"),U=_(()=>{let n=0,t=0;for(const s of o.items){const x=Number(s.quantity)||0,r=Number(s.unit_price)||0,v=Number(s.discount)||0,V=Number(s.tax_percent??18)||0,q=Math.max(0,x*r-v),P=q*(V/100);n+=q,t+=P}return{subtotal:n,tax:t,total:n+t}});$(()=>o.customer_id,n=>{if(!n){o.customer_tax_id="",o.customer_phone="";return}const t=d.customers.find(s=>s.id==n);t?(o.customer_tax_id=t.document_number??"",o.customer_phone=t.phone??""):(o.customer_tax_id="",o.customer_phone="")},{immediate:!!(d.quotation||d.sale)});function F(){o.items.push({product_id:null,description:"",unit:"UND",quantity:1,unit_price:0,discount:0,tax_percent:18})}function M(n){o.items.length<=1||o.items.splice(n,1)}function E(n){const t=o.items[n].product_id;if(!t)return;const s=d.products.find(x=>x.id===t);s&&(o.items[n].description=s.name,o.items[n].unit=s.unit,o.items[n].unit_price=s.price,o.items[n].tax_percent=s.tax_pct??18)}function I(n){const t=Number(n.quantity)||0,s=Number(n.unit_price)||0,x=Number(n.discount)||0,r=Number(n.tax_percent??18)||0,v=Math.max(0,t*s-x),V=v*(r/100);return v+V}function L(){g.value&&d.sale?o.put(`/sales/${d.sale.id}`,{preserveScroll:!0}):o.post("/sales",{preserveScroll:!0})}return(n,t)=>(m(),p(w,null,[e("div",J,[e("h1",K,i(g.value?"Editar venta":"Nueva venta"),1),e("div",W,[h(l(A),{href:"/sales",class:"px-3 py-2 rounded-lg border bg-background hover:bg-muted/60 text-sm"},{default:R(()=>[...t[19]||(t[19]=[D(" Cancelar ",-1)])]),_:1}),e("button",{class:"px-4 py-2 rounded-lg bg-primary text-primary-foreground text-sm",disabled:l(o).processing,onClick:L},i(g.value?"Actualizar venta":"Guardar venta"),9,Y)])]),Object.keys(l(o).errors).length?(m(),p("div",Z," Hay errores en el formulario. Revisa los campos marcados. ")):c("",!0),e("div",Q,[e("div",X,[t[25]||(t[25]=e("div",{class:"flex items-center gap-3"},[e("div",{class:"h-12 w-32 bg-slate-100 rounded-md flex items-center justify-center text-[10px] font-semibold text-slate-500"}," LOGO "),e("div",null,[e("p",{class:"text-sm font-semibold"},"AGENCIA DN"),e("p",{class:"text-xs text-muted-foreground"}," Marketing & Diseño Web ")])],-1)),e("div",tt,[e("div",null,[t[21]||(t[21]=e("p",{class:"text-[11px] uppercase tracking-wide text-muted-foreground"}," Venta ",-1)),e("p",et,[t[20]||(t[20]=D(" No. ",-1)),e("span",st,i(l(o).series)+"-"+i(l(o).number||"—"),1)]),t[22]||(t[22]=e("p",{class:"mt-1 text-xs text-muted-foreground"}," Emitida por: Dani ",-1))]),e("div",ot,[e("div",nt,[t[23]||(t[23]=e("label",{class:"block text-[11px] font-medium mb-1"},"Serie",-1)),a(e("input",{"onUpdate:modelValue":t[0]||(t[0]=s=>l(o).series=s),readonly:"",class:"w-full border rounded-lg px-2 py-1 text-xs text-right bg-gray-100 opacity-70"},null,512),[[u,l(o).series]]),l(o).errors.series?(m(),p("p",lt,i(l(o).errors.series),1)):c("",!0)]),e("div",dt,[t[24]||(t[24]=e("label",{class:"block text-[11px] font-medium mb-1"},"Número",-1)),a(e("input",{"onUpdate:modelValue":t[1]||(t[1]=s=>l(o).number=s),readonly:"",class:"w-full border rounded-lg px-2 py-1 text-xs text-right bg-gray-100 opacity-70"},null,512),[[u,l(o).number]]),l(o).errors.number?(m(),p("p",rt,i(l(o).errors.number),1)):c("",!0)])])])]),e("div",at,[e("div",it,[e("div",null,[t[28]||(t[28]=e("label",{class:"block text-xs font-medium mb-1"},"Cliente *",-1)),e("div",ut,[a(e("select",{"onUpdate:modelValue":t[2]||(t[2]=s=>l(o).customer_id=s),class:"flex-1 border rounded-lg px-2 py-2 text-sm"},[t[26]||(t[26]=e("option",{value:null,disabled:""},"Selecciona cliente…",-1)),(m(!0),p(w,null,C(d.customers,s=>(m(),p("option",{key:s.id,value:s.id},i(s.name),9,pt))),128))],512),[[y,l(o).customer_id]]),e("button",{type:"button",class:"inline-flex items-center gap-1 text-xs text-primary hover:underline mb-1",onClick:t[3]||(t[3]=s=>f.value=!0)},[...t[27]||(t[27]=[e("span",{class:"text-lg leading-none"},"＋",-1),e("span",null,"Nuevo cliente",-1)])])])]),e("div",mt,[e("div",null,[t[29]||(t[29]=e("label",{class:"block text-xs font-medium mb-1 opacity-60"}," Identificación ",-1)),a(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>l(o).customer_tax_id=s),readonly:"",class:"w-full border rounded-lg px-2 py-2 text-sm bg-gray-100 opacity-60",placeholder:"RUC / DNI"},null,512),[[u,l(o).customer_tax_id]])]),e("div",null,[t[30]||(t[30]=e("label",{class:"block text-xs font-medium mb-1 opacity-60"}," Teléfono ",-1)),a(e("input",{"onUpdate:modelValue":t[5]||(t[5]=s=>l(o).customer_phone=s),readonly:"",class:"w-full border rounded-lg px-2 py-2 text-sm bg-gray-100 opacity-60",placeholder:"Teléfono"},null,512),[[u,l(o).customer_phone]])])])]),e("div",xt,[e("div",null,[t[31]||(t[31]=e("label",{class:"block text-xs font-medium mb-1"},"Fecha emisión *",-1)),a(e("input",{type:"date","onUpdate:modelValue":t[6]||(t[6]=s=>l(o).issue_date=s),class:"w-full border rounded-lg px-2 py-2 text-sm"},null,512),[[u,l(o).issue_date]])]),e("div",null,[t[32]||(t[32]=e("label",{class:"block text-xs font-medium mb-1"},"Fecha vencimiento",-1)),a(e("input",{type:"date","onUpdate:modelValue":t[7]||(t[7]=s=>l(o).due_date=s),class:"w-full border rounded-lg px-2 py-2 text-sm"},null,512),[[u,l(o).due_date]])]),e("div",null,[t[34]||(t[34]=e("label",{class:"block text-xs font-medium mb-1"},"Moneda",-1)),a(e("select",{"onUpdate:modelValue":t[8]||(t[8]=s=>l(o).currency=s),class:"w-full border rounded-lg px-2 py-2 text-sm"},[...t[33]||(t[33]=[e("option",{value:"PEN"},"PEN - Soles",-1),e("option",{value:"USD"},"USD - Dólares",-1)])],512),[[y,l(o).currency]])]),e("div",null,[t[35]||(t[35]=e("label",{class:"block text-xs font-medium mb-1"}," Condición de pago ",-1)),a(e("input",{type:"text","onUpdate:modelValue":t[9]||(t[9]=s=>l(o).payment_term=s),placeholder:"Contado, 7 días, 30 días...",class:"w-full border rounded-lg px-2 py-2 text-sm"},null,512),[[u,l(o).payment_term]])])])]),e("div",ct,[e("div",bt,[e("table",yt,[e("thead",ft,[e("tr",gt,[t[36]||(t[36]=e("th",{class:"p-2 w-56"},"Item facturable",-1)),t[37]||(t[37]=e("th",{class:"p-2 w-24"},"Unidad",-1)),t[38]||(t[38]=e("th",{class:"p-2 w-24 text-right"},"Precio un.",-1)),e("th",vt,"Desc ("+i(b.value)+")",1),t[39]||(t[39]=e("th",{class:"p-2 w-20 text-right"},"IGV %",-1)),t[40]||(t[40]=e("th",{class:"p-2 w-20 text-right"},"Cantidad",-1)),t[41]||(t[41]=e("th",{class:"p-2 w-28 text-right"},"Total",-1)),t[42]||(t[42]=e("th",{class:"p-2 w-8"},null,-1))])]),e("tbody",null,[(m(!0),p(w,null,C(l(o).items,(s,x)=>(m(),p("tr",{key:x,class:"border-b last:border-b-0"},[e("td",_t,[a(e("select",{"onUpdate:modelValue":r=>s.product_id=r,onChange:r=>E(x),class:"w-full border rounded-lg px-2 py-1 text-xs md:text-sm"},[t[43]||(t[43]=e("option",{value:null},"Buscar item facturable…",-1)),(m(!0),p(w,null,C(d.products,r=>(m(),p("option",{key:r.id,value:r.id},i(r.name),9,kt))),128))],40,wt),[[y,s.product_id]])]),e("td",Ut,[a(e("input",{"onUpdate:modelValue":r=>s.unit=r,class:"w-full border rounded-lg px-2 py-1 text-xs md:text-sm",placeholder:"UND"},null,8,Vt),[[u,s.unit]])]),e("td",Nt,[a(e("input",{type:"number",step:"0.01","onUpdate:modelValue":r=>s.unit_price=r,class:"w-full border rounded-lg px-2 py-1 text-xs md:text-sm text-right"},null,8,Ct),[[u,s.unit_price,void 0,{number:!0}]])]),e("td",qt,[a(e("input",{type:"number",step:"0.01","onUpdate:modelValue":r=>s.discount=r,class:"w-full border rounded-lg px-2 py-1 text-xs md:text-sm text-right"},null,8,St),[[u,s.discount,void 0,{number:!0}]])]),e("td",ht,[a(e("select",{"onUpdate:modelValue":r=>s.tax_percent=r,class:"w-full border rounded-lg px-2 py-1 text-xs md:text-sm"},[...t[44]||(t[44]=[e("option",{value:0},"Exonerado (0%)",-1),e("option",{value:0},"Inafecto (0%)",-1),e("option",{value:18},"IGV (18%)",-1)])],8,Dt),[[y,s.tax_percent,void 0,{number:!0}]])]),e("td",jt,[a(e("input",{type:"number",step:"0.001","onUpdate:modelValue":r=>s.quantity=r,class:"w-full border rounded-lg px-2 py-1 text-xs md:text-sm text-right"},null,8,Tt),[[u,s.quantity,void 0,{number:!0}]])]),e("td",Ft,i(b.value)+" "+i(I(s).toFixed(2)),1),e("td",Mt,[e("button",{class:"text-red-500 text-sm",type:"button",onClick:r=>M(x)}," ✕ ",8,Et)])]))),128))])])]),e("div",{class:"pt-3"},[e("button",{class:"text-primary text-sm font-medium",type:"button",onClick:F}," + Agregar línea ")])]),e("div",It,[e("div",Lt,[t[45]||(t[45]=e("label",{class:"block text-xs font-medium mb-1"}," Notas ",-1)),a(e("textarea",{"onUpdate:modelValue":t[10]||(t[10]=s=>l(o).notes=s),rows:"4",class:"w-full border rounded-lg px-3 py-2 text-sm",placeholder:"Notas adicionales para el cliente..."},null,512),[[u,l(o).notes]])]),e("div",Pt,[e("div",Gt,[e("div",$t,[t[46]||(t[46]=e("span",{class:"text-muted-foreground"},"Subtotal",-1)),e("span",null,i(b.value)+" "+i(U.value.subtotal.toFixed(2)),1)]),e("div",Rt,[t[47]||(t[47]=e("span",{class:"text-muted-foreground"},"IGV",-1)),e("span",null,i(b.value)+" "+i(U.value.tax.toFixed(2)),1)]),e("div",At,[t[48]||(t[48]=e("span",null,"Total",-1)),e("span",null,i(b.value)+" "+i(U.value.total.toFixed(2)),1)])])])])]),g.value?c("",!0):(m(),p("div",Bt,[e("div",Ot,[t[50]||(t[50]=e("div",null,[e("p",{class:"text-sm font-semibold"},"Registrar pago inicial"),e("p",{class:"text-xs text-muted-foreground"}," Opcional. Si ya recibiste un pago de esta venta, regístralo aquí. ")],-1)),e("label",zt,[t[49]||(t[49]=e("span",null,"Registrar pago",-1)),a(e("input",{type:"checkbox","onUpdate:modelValue":t[11]||(t[11]=s=>l(o).register_payment=s),class:"h-4 w-4"},null,512),[[B,l(o).register_payment]])])]),l(o).register_payment?(m(),p("div",Ht,[e("div",null,[t[51]||(t[51]=e("label",{class:"block text-xs font-medium mb-1"},"Fecha",-1)),a(e("input",{type:"date","onUpdate:modelValue":t[12]||(t[12]=s=>l(o).payment_date=s),class:"w-full border rounded-lg px-2 py-2 text-sm"},null,512),[[u,l(o).payment_date]])]),e("div",null,[t[53]||(t[53]=e("label",{class:"block text-xs font-medium mb-1"},"Método",-1)),a(e("select",{"onUpdate:modelValue":t[13]||(t[13]=s=>l(o).payment_method=s),class:"w-full border rounded-lg px-2 py-2 text-sm"},[...t[52]||(t[52]=[O('<option value="">Seleccione…</option><option value="efectivo">Efectivo</option><option value="transferencia">Transferencia</option><option value="tarjeta_credito">Tarjeta de crédito</option><option value="tarjeta_debito">Tarjeta de débito</option><option value="yape_plin">Yape / Plin</option>',6)])],512),[[y,l(o).payment_method]])]),e("div",null,[t[54]||(t[54]=e("label",{class:"block text-xs font-medium mb-1"},"Referencia",-1)),a(e("input",{type:"text","onUpdate:modelValue":t[14]||(t[14]=s=>l(o).payment_reference=s),class:"w-full border rounded-lg px-2 py-2 text-sm",placeholder:"N° operación, voucher…"},null,512),[[u,l(o).payment_reference]])]),e("div",null,[t[55]||(t[55]=e("label",{class:"block text-xs font-medium mb-1"},"Monto",-1)),a(e("input",{type:"number",step:"0.01","onUpdate:modelValue":t[15]||(t[15]=s=>l(o).payment_amount=s),class:"w-full border rounded-lg px-2 py-2 text-sm text-right",placeholder:"0.00"},null,512),[[u,l(o).payment_amount,void 0,{number:!0}]])])])):c("",!0),l(o).register_payment?(m(),p("div",Jt,[t[56]||(t[56]=e("label",{class:"block text-xs font-medium mb-1"},"Notas del pago",-1)),a(e("textarea",{"onUpdate:modelValue":t[16]||(t[16]=s=>l(o).payment_notes=s),rows:"2",class:"w-full border rounded-lg px-2 py-2 text-sm",placeholder:"Notas internas sobre este pago..."},null,512),[[u,l(o).payment_notes]])])):c("",!0)])),h(H,{open:f.value,mode:"create",onClose:t[17]||(t[17]=s=>f.value=!1),onSaved:t[18]||(t[18]=()=>{f.value=!1,l(z).reload({only:["customers"]})})},null,8,["open"])],64))}});export{Yt as _};
